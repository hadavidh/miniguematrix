name: CI + Docker

on: [push]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      # Contournement possible du 403 Maven Central (repo.maven.apache.org)
      - name: Configure Maven mirror (repo1.maven.org)
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<'XML'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <mirrors>
              <mirror>
                <id>central-repo1</id>
                <mirrorOf>central</mirrorOf>
                <url>https://repo1.maven.org/maven2/</url>
              </mirror>
            </mirrors>
          </settings>
          XML

      - name: Run backend tests
        run: mvn -s ~/.m2/settings.xml -B clean test
        working-directory: demo

      # Construit le jar (utile pour docker si Dockerfile runtime-only)
      - name: Package backend jar (skip tests)
        run: mvn -s ~/.m2/settings.xml -B -DskipTests package
        working-directory: demo

      # Upload du jar comme artifact pour le job docker (optionnel mais pratique)
      - name: Upload jar artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: demo/target/*.jar

  frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps
        run: npm ci
        working-directory: frontend

      - name: Run frontend tests (if present)
        run: npm test --if-present
        working-directory: frontend

      - name: Build frontend
        run: npm run build
        working-directory: frontend

  docker:
   runs-on: ubuntu-latest
   needs: [backend, frontend]
   steps:
    - uses: actions/checkout@v4

    - name: Download jar artifact
      uses: actions/download-artifact@v4
      with:
        name: backend-jar
        path: demo/target

    - name: Log in to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract Docker metadata (tags/labels)
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=sha,format=long
          type=raw,value=latest

    - name: Build and push image
      uses: docker/build-push-action@v6
      with:
        context: demo
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

    - name: Run container (smoke test)
      run: |
        IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}"
        docker pull "$IMAGE"
        docker run -d --name gematria -p 8080:8080 "$IMAGE"

        for i in {1..30}; do
          if curl -fsS http://localhost:8080/actuator/health >/dev/null 2>&1; then
            echo "App is healthy"
            exit 0
          fi
          sleep 2
        done

        echo "Healthcheck failed"
        docker logs gematria
        exit 1

    - name: Cleanup
      if: always()
      run: |
        docker rm -f gematria || true